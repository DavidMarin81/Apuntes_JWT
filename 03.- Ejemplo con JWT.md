# Guia paso a paso con JWT
- Construir una aplicación simple con login usando JWT.

## Estructura de la guía
- Requisitos y herramientas
- Crear la base de datos MySQL
- Backend en C#
    - Crear proyecto
    - Añadir paquetes NuGet
    - Configurar appsettings.json (JWT settings, connection string)
    - Definir User y DbContext
    - Registro / Login
    - Generar JWT (clase / servicio)
    - Proteger endpoints y configurar JwtBearer
- Probar la API
- Frontend en React
    - Crear proyecto
    - Formulario de login
    - Llamada a POST /api/auth/login y almacenamiento del token
    - Ejemplo de ProtectedRoute y uso del header Authorization: Bearer <token>
- Buenas prácticas y siguientes pasos (refresh token, HttpOnly cookies, HTTPS, usar identity en producción)

## 1.- Crear la base de datos
- Script
    ~~~sql
    CREATE DATABASE jwt_demo;
    USE jwt_demo;


    CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(100) NOT NULL UNIQUE,
    password_hash VARCHAR(500) NOT NULL,
    role VARCHAR(50) DEFAULT 'user',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    ~~~

## 2.- Backend en C# (paso a paso)
### Crear el proyecto e instalar los paquetes
- Paquetes NuGet
    ~~~bash
    dotnet add package Microsoft.AspNetCore.Authentication.JwtBearer
    dotnet add package Microsoft.EntityFrameworkCore
    dotnet add package Pomelo.EntityFrameworkCore.MySql
    dotnet add package Microsoft.EntityFrameworkCore.Design
    ~~~
- Crear appsettings.json
    - Importante: 
        - En producción, guardar "SecretKey" en variables de entorno
    ~~~json
    {
        "ConnectionStrings": {
        "DefaultConnection": "server=localhost;port=3306;database=jwt_demo;user=root;password=TuPass"
        },
        "JwtSettings": {
        "SecretKey": "UnaClaveMuyLargaYSecretaQueNoSeComparte",
        "Issuer": "MiApi",
        "Audience": "MiCliente",
        "ExpiresMinutes": 60
        },
        "Logging": { "LogLevel": { "Default": "Information" } },
        "AllowedHosts": "*"
    }
    ~~~
- Modelos y DbContext
    - Crea Models/User.cs
        ~~~C#
        public class User {
            public int Id { get; set; }
            public string Username { get; set; } = string.Empty;
            public string PasswordHash { get; set; } = string.Empty;
            public string Role { get; set; } = "user";
            public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
        }
        ~~~
    - Se crean los DTOs
        - LoginDTO.cs
            ~~~C#
            namespace Prueba_JWT.Models
            {
                public class LoginDTO
                {
                    public string Username { get; set; } = string.Empty;
                    public string Password { get; set; } = string.Empty;
                }
            }
            ~~~
        - RegisterDTO.cs
            ~~~C#
            namespace Prueba_JWT.Models
            {
                public class RegisterDTO
                {
                    public string Username { get; set; } = string.Empty;
                    public string Password { get; set; } = string.Empty;
                }
            }
            ~~~
    - Crea en Data/AppDbContext.cs
        ~~~C#
        using Microsoft.EntityFrameworkCore;
            public class AppDbContext : DbContext {
            public AppDbContext(DbContextOptions<AppDbContext> options) : base(options) {}
            public DbSet<User> Users { get; set; }
        }
        ~~~
    - Registra el DbContext en Program.cs usando Pomelo
        ~~~C#
        builder.Services.AddDbContext<AppDbContext>(options =>
            options.UseMySql(
                builder.Configuration.GetConnectionString("DefaultConnection"),
                ServerVersion.AutoDetect(builder.Configuration.GetConnectionString("DefaultConnection"))
            )
        );
        ~~~
- Crea el TokenService para generar JWT
    - Crea una carpeta Service y dentro un archivo TokenService.cs
        ~~~C#
        using JwtAuthApi.Models;
        using Microsoft.Extensions.Configuration;
        using Microsoft.IdentityModel.Tokens;
        using System.IdentityModel.Tokens.Jwt;
        using System.Security.Claims;
        using System.Text;

        namespace JwtAuthApi.Services
        {
            public class TokenService
            {
                private readonly IConfiguration _configuration;

                public TokenService(IConfiguration configuration)
                {
                    _configuration = configuration;
                }

                public string GenerateToken(User user)
                {
                    var jwtSettings = _configuration.GetSection("JwtSettings");

                    var claims = new[]
                    {
                        new Claim(ClaimTypes.NameIdentifier, user.Id.ToString()),
                        new Claim(ClaimTypes.Name, user.Username),
                        new Claim(ClaimTypes.Role, user.Role)
                    };

                    var key = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(jwtSettings["SecretKey"]));
                    var creds = new SigningCredentials(key, SecurityAlgorithms.HmacSha256);

                    var token = new JwtSecurityToken(
                        issuer: jwtSettings["Issuer"],
                        audience: jwtSettings["Audience"],
                        claims: claims,
                        expires: DateTime.UtcNow.AddMinutes(double.Parse(jwtSettings["ExpiresMinutes"])),
                        signingCredentials: creds
                    );

                    return new JwtSecurityTokenHandler().WriteToken(token);
                }
            }
        }
        ~~~
        
- Servicio para generar JWT
    - Crea un servicio TokenService que le JWTSettings y genere un JWTSecurityToken con JWTSecurityTokenHandler
        ~~~C#
        var claims = new[] {
            new Claim(ClaimTypes.NameIdentifier, user.Id.ToString()),
            new Claim(ClaimTypes.Name, user.Username),
            new Claim(ClaimTypes.Role, user.Role)
            };


        var key = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(jwtSettings.SecretKey));
        var creds = new SigningCredentials(key, SecurityAlgorithms.HmacSha256);
        var token = new JwtSecurityToken(
        issuer: jwtSettings.Issuer,
        audience: jwtSettings.Audience,
        claims: claims,
        expires: DateTime.UtcNow.AddMinutes(jwtSettings.ExpiresMinutes),
        signingCredentials: creds);


        var tokenString = new JwtSecurityTokenHandler().WriteToken(token);
        ~~~
- Configurar autenticación JWT
    - En Program.cs
        ~~~C#
        builder.Services.AddAuthentication(options => {
            options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
            options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
        }).AddJwtBearer(options => {
            options.TokenValidationParameters = new TokenValidationParameters {
                ValidateIssuer = true,
                ValidateAudience = true,
                ValidateLifetime = true,
                ValidateIssuerSigningKey = true,
                ValidIssuer = jwtSettings.Issuer,
                ValidAudience = jwtSettings.Audience,
                IssuerSigningKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(jwtSettings.SecretKey))
            };
        });

        app.UseAuthentication();
        app.UseAuthorization();
        ~~~
- Controlador de autenticación (AuthController)
    - Rutas principales
        - POST /api/auth/register = registra user, hashea la contraseña y la guarda en BD
        - POST /api/auth/login = valida credenciales y devuelve { token: "..." }
    - Ejemplo esquemático de login:
        ~~~C#
        [HttpPost("login")]
        public async Task<IActionResult> Login(LoginDto dto) {
            var user = await _db.Users.FirstOrDefaultAsync(u => u.Username == dto.Username);
            if (user == null) return Unauthorized();
            var verify = _hasher.VerifyHashedPassword(user, user.PasswordHash, dto.Password);
            if (verify == PasswordVerificationResult.Failed) return Unauthorized();
            var token = _tokenService.GenerateToken(user);
            return Ok(new { token });
        }
        ~~~
- Probar la API
    - Usar Postman o Swagger
        - POST /api/auth/register con { username, password }
        - POST /api/auth/login
    - Copia el token y prueba un endpoint protegido poniendo en headers: 
        - Authorization: Bearer <token>
- Frontend en React
    - ...