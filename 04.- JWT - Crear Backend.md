# Creando un proyecto con JWT
## Crear un proyecto en Visual Studio
- Abrir un proyecto "ASP.NET Core Web Api"
- Al abrir el proyecto debe aparecer la página con swagger

## Configuración inicial del backend
- Instalar los paquetes NuGet
    ~~~bash
    Install-Package Dapper
    Install-Package MySqlConnector
    Install-Package Microsoft.AspNetCore.Authentication.JwtBearer -Version 8.0.10
    Install-Package Swashbuckle.AspNetCore -Version 6.7.0
    Install-Package BCrypt.Net-Next
    ~~~
    - Dapper -> micro ORM para consultas SQL rápidas
    - MySQLConnector -> driver MySQL compatible con dapper
    - JWTBearer -> autenticación basada en tokens JWT
    - Swashbuckle.AspNetCore -> Swagger (ya incluído en el proyecto)

- Configurar 'appsettings.json'
    - Abre el archivo y deja algo así (ajustando tus datos MySQL y cambiando la "Jwt:Key")
    - Se añade "ConnectionStrings" y "Jwt"
        ~~~json
        {
        "ConnectionStrings": {
            "DefaultConnection": "server=localhost;port=3306;database=jwt_auth;user=root;password=abc123."
        },
        "Jwt": {
            "Key": "CAMBIA_ESTE_SECRET_POR_UNO_MUY_LARGO_Y_UNICO",
            "Issuer": "PruebaJWT02_backend",
            "Audience": "PruebaJWT02_frontend",
            "ExpiryMinutes": 60
        },
        "Logging": {
            "LogLevel": {
            "Default": "Information",
            "Microsoft.AspNetCore": "Warning"
            }
        },
        "AllowedHosts": "*"
        }
        ~~~
    - `DefaultConnection`: cadena de conexión MySQL (ajusta usuario y contraseña)
    - `Jwt.Key`: clave secreta usada par firmar tokens (¡NUNCA LA PUBLIQUES!)
    - `Issuer` / `Audience`: identificadores del emisor y los destinatarios del token
        - `Issuer`: quién emitió el token (Puede ponerse cualquier nombre)
        - `Audience`: para quién está destinado el token (Puede ponerse cualquier nombre)
    - `ExpiryMinutes`: duración del token (en minutos)

# Creación de la base de datos
- Ejecutamos el script para crear la base de datos
    ~~~sql
    CREATE DATABASE IF NOT EXISTS jwt_auth CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
    USE jwt_auth;

    CREATE TABLE roles (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(50) NOT NULL UNIQUE
    );

    CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    email VARCHAR(255) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    role_id INT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (role_id) REFERENCES roles(id)
    );

    -- insertar roles iniciales
    INSERT INTO roles (name) VALUES ('standard'), ('master'), ('intranet');
    ~~~
- `roles`: Contiene los tres tipos de usuario: `standard`, `master` e `intranet`
- `users`: Cada usuario tiene un email, password (hashed) y un `role_id` que referencia a la tabla `roles`
- Aún no insertamos usuario. Los crearemos desde el endpoint `register` usando la lógica que implementaremos más adelante

## Creación de los modelos y los DTOs
- LOS MODELOS DEBERIAN COINCIDIR CON LOS NOMBRES DE LAS TABLAS DE LA BASE DE DATOS
- SI NO COINCIDEN, SE PUEDEN USAR ALIAS PARA QUE COINCIDAN
- Crea una carpeta llamada `Models` dentro del proyecto
    - `Role.cs`
        ~~~csharp
        namespace Prueba02JWT.Models
        {
            public class Role
            {
                public int Id { get; set; }
                public string Name { get; set; } = null!;
            }
        }
        ~~~
    - `User.cs`
        ~~~csharp
        namespace Prueba02JWT.Models
        {
            public class User
            {
                public int Id { get; set; }
                public string Email { get; set; } = null!;
                public string PasswordHash { get; set; } = null!;
                public int RoleId { get; set; }
                public Role? Role { get; set; }  // Navegación opcional
                public DateTime CreatedAt { get; set; }
            }
        }
        ~~~
- Crea una carpeta llamada `Dtos`
    - `RegisterDto.cs`
        ~~~csharp
        namespace Prueba02JWT.Dtos
        {
            public class RegisterDto
            {
                public string Email { get; set; } = null!;
                public string Password { get; set; } = null!;
                public string Role { get; set; } = "standard"; // default a standard
            }
        }
        ~~~
    - `Login.cs`
        ~~~csharp
        namespace Prueba02JWT.Dtos
        {
            public class LoginDto
            {
                public string Email { get; set; } = null!;
                public string Password { get; set; } = null!;
            }
        }
        ~~~
    - `UserDto.cs`
        ~~~csharp
        namespace Prueba02JWT.Dtos
        {
            public class UserDto
            {
                public int Id { get; set; }
                public string Email { get; set; } = null!;
                public string Role { get; set; } = null!;
            }
        }
        ~~~

## Crear carpeta `Repository`
- `IuserRepository.cs`
    ~~~csharp
    using Prueba02JWT.Models;

    namespace Prueba02JWT.Repositories
    {
        public interface IUserRepository
        {
            Task<User?> GetByEmailAsync(string email);
            Task<User?> GetByIdAsync(int id);
            Task<int> CreateUserAsync(User user);
        }
    }
    ~~~
- `IRoleRepository`
    ~~~csharp
    using Prueba02JWT.Models;

    namespace Prueba02JWT.Repositories
    {
        public interface IRoleRepository
        {
            Task<Role?> GetByNameAsync(string name);
            Task<Role?> GetByIdAsync(int id);
        }
    }
    ~~~

## Implementación usando Dapper
- `UserRepository.cs`
    ~~~csharp
    using Dapper;
    using MySqlConnector;
    using Prueba02JWT.Models;

    namespace Prueba02JWT.Repositories
    {
        public class UserRepository : IUserRepository
        {
            private readonly string _connectionString;

            public UserRepository(IConfiguration configuration)
            {
                _connectionString = configuration.GetConnectionString("DefaultConnection");
            }

            private MySqlConnection GetConnection() => new MySqlConnection(_connectionString);

            public async Task<User?> GetByEmailAsync(string email)
            {
                using var connection = GetConnection();
                var sql = "SELECT u.*, r.id as RoleId, r.name as RoleName FROM users u " +
                        "JOIN roles r ON u.role_id = r.id WHERE u.email = @Email";
                var result = await connection.QueryAsync<User, Role, User>(
                    sql,
                    (user, role) => { user.Role = role; return user; },
                    new { Email = email },
                    splitOn: "RoleId"
                );
                return result.FirstOrDefault();
            }

            public async Task<User?> GetByIdAsync(int id)
            {
                using var connection = GetConnection();
                var sql = "SELECT u.*, r.id as RoleId, r.name as RoleName FROM users u " +
                        "JOIN roles r ON u.role_id = r.id WHERE u.id = @Id";
                var result = await connection.QueryAsync<User, Role, User>(
                    sql,
                    (user, role) => { user.Role = role; return user; },
                    new { Id = id },
                    splitOn: "RoleId"
                );
                return result.FirstOrDefault();
            }

            public async Task<int> CreateUserAsync(User user)
            {
                using var connection = GetConnection();

                var insertSql = "INSERT INTO users (email, password_hash, role_id) VALUES (@Email, @PasswordHash, @RoleId)";
                await connection.ExecuteAsync(insertSql, user);

                var id = await connection.ExecuteScalarAsync<int>("SELECT LAST_INSERT_ID()");
                return id;
            }
        }
    }
    ~~~
- `RoleRepository.cs`
    ~~~csharp
    using Dapper;
    using MySqlConnector;
    using Prueba02JWT.Models;

    namespace Prueba02JWT.Repositories
    {
        public class RoleRepository : IRoleRepository
        {
            private readonly string _connectionString;

            public RoleRepository(IConfiguration configuration)
            {
                _connectionString = configuration.GetConnectionString("DefaultConnection");
            }

            private MySqlConnection GetConnection() => new MySqlConnection(_connectionString);

            public async Task<Role?> GetByNameAsync(string name)
            {
                using var connection = GetConnection();
                var sql = "SELECT * FROM roles WHERE name = @Name";
                return await connection.QueryFirstOrDefaultAsync<Role>(sql, new { Name = name });
            }

            public async Task<Role?> GetByIdAsync(int id)
            {
                using var connection = GetConnection();
                var sql = "SELECT * FROM roles WHERE id = @Id";
                return await connection.QueryFirstOrDefaultAsync<Role>(sql, new { Id = id });
            }
        }
    }

    ~~~

## Crear carpeta `Services`
- Creamos la carpeta `Services`
- `IAuthService`
    ~~~csharp
    using Prueba02JWT.Dtos;

    namespace Prueba02JWT.Services
    {
        public interface IAuthService
        {
            Task<UserDto?> RegisterAsync(RegisterDto dto);
            Task<string?> LoginAsync(LoginDto dto);
        }
    }
    ~~~
- `AuthService.cs`
    ~~~csharp
    using Prueba02JWT.Dtos;
    using Prueba02JWT.Models;
    using Prueba02JWT.Repositories;
    using BCrypt.Net;
    using Microsoft.IdentityModel.Tokens;
    using System.IdentityModel.Tokens.Jwt;
    using System.Security.Claims;
    using System.Text;

    namespace Prueba02JWT.Services
    {
        public class AuthService : IAuthService
        {
            private readonly IUserRepository _userRepository;
            private readonly IRoleRepository _roleRepository;
            private readonly IConfiguration _configuration;

            public AuthService(IUserRepository userRepository, IRoleRepository roleRepository, IConfiguration configuration)
            {
                _userRepository = userRepository;
                _roleRepository = roleRepository;
                _configuration = configuration;
            }

            public async Task<UserDto?> RegisterAsync(RegisterDto dto)
            {
                // 1. Verificar si el email ya existe
                var existingUser = await _userRepository.GetByEmailAsync(dto.Email);
                if (existingUser != null) return null;

                // 2. Obtener rol
                var role = await _roleRepository.GetByNameAsync(dto.Role);
                if (role == null) return null;

                // 3. Hashear contraseña
                string passwordHash = BCrypt.Net.BCrypt.HashPassword(dto.Password);

                // 4. Crear usuario
                var user = new User
                {
                    Email = dto.Email,
                    PasswordHash = passwordHash,
                    RoleId = role.Id
                };

                user.Id = await _userRepository.CreateUserAsync(user);
                user.Role = role;

                // 5. Devolver UserDto
                return new UserDto
                {
                    Id = user.Id,
                    Email = user.Email,
                    Role = user.Role.Name
                };
            }

            public async Task<string?> LoginAsync(LoginDto dto)
            {
                // 1. Buscar usuario por email
                var user = await _userRepository.GetByEmailAsync(dto.Email);
                if (user == null) return null;

                // 2. Verificar contraseña
                if (!BCrypt.Net.BCrypt.Verify(dto.Password, user.PasswordHash)) return null;

                // 3. Generar JWT
                var tokenHandler = new JwtSecurityTokenHandler();
                var key = Encoding.UTF8.GetBytes(_configuration["Jwt:Key"]);
                var tokenDescriptor = new SecurityTokenDescriptor
                {
                    Subject = new ClaimsIdentity(new[]
                    {
                        new Claim(ClaimTypes.NameIdentifier, user.Id.ToString()),
                        new Claim(ClaimTypes.Email, user.Email),
                        new Claim(ClaimTypes.Role, user.Role!.Name)
                    }),
                    Expires = DateTime.UtcNow.AddMinutes(double.Parse(_configuration["Jwt:ExpiryMinutes"])),
                    Issuer = _configuration["Jwt:Issuer"],
                    Audience = _configuration["Jwt:Audience"],
                    SigningCredentials = new SigningCredentials(new SymmetricSecurityKey(key), SecurityAlgorithms.HmacSha256Signature)
                };

                var token = tokenHandler.CreateToken(tokenDescriptor);
                return tokenHandler.WriteToken(token);
            }
        }
    }

    ~~~

## Crear la carpeta `Controllers`
- Creamos la carpeta `Controllers`
- `AuthController.cs`
    ~~~csharp
    using Microsoft.AspNetCore.Mvc;
    using Prueba02JWT.Dtos;
    using Prueba02JWT.Services;

    namespace Prueba02JWT.Controllers
    {
        [ApiController]
        [Route("api/[controller]")]
        public class AuthController : ControllerBase
        {
            private readonly IAuthService _authService;

            public AuthController(IAuthService authService)
            {
                _authService = authService;
            }

            [HttpPost("register")]
            public async Task<IActionResult> Register([FromBody] RegisterDto dto)
            {
                var user = await _authService.RegisterAsync(dto);
                if (user == null)
                    return BadRequest(new { message = "El email ya está en uso o el rol no existe." });

                return Ok(user);
            }

            [HttpPost("login")]
            public async Task<IActionResult> Login([FromBody] LoginDto dto)
            {
                var token = await _authService.LoginAsync(dto);
                if (token == null)
                    return Unauthorized(new { message = "Credenciales incorrectas." });

                return Ok(new { token });
            }
        }
    }
    ~~~

## Registra los servicios y los repositorios en `Program.cs`
- Añadir estas líneas para inyectar los servicios y repositorios
    ~~~csharp
    builder.Services.AddScoped<IUserRepository, UserRepository>();
    builder.Services.AddScoped<IRoleRepository, RoleRepository>();
    builder.Services.AddScoped<IAuthService, AuthService>();
    ~~~

- Ejemplo de como quedaría
    ~~~csharp
    using Prueba02JWT.Repository;
    using Prueba02JWT.Services;

    var builder = WebApplication.CreateBuilder(args);

    // Add services to the container.

    builder.Services.AddControllers();
    // Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle
    builder.Services.AddEndpointsApiExplorer();
    builder.Services.AddSwaggerGen();

    // Registramos los servicios y los repositorios
    builder.Services.AddScoped<IUserRepository, UserRepository>();
    builder.Services.AddScoped<IRoleRepository, RoleRepository>();
    builder.Services.AddScoped<IAuthService, AuthService>();

    var app = builder.Build();

    // Configure the HTTP request pipeline.
    if (app.Environment.IsDevelopment())
    {
        app.UseSwagger();
        app.UseSwaggerUI();
    }

    app.UseHttpsRedirection();

    app.UseAuthorization();

    app.MapControllers();

    app.Run();
    ~~~

## 