# Login seguro con JWT
## Login inicial: usuario + cif + contraseña
- El usuario abre la página de login
- El formulario solicita:
    - Usuario
    - CIF
    - Contraseña
- Cuando el usuario pulsa "Entrar", el frontend envía una petición POST al backend con los datos:
    ~~~js
    POST /api/auth/login
    Content-Type: application/json

    {
    "usuario": "david",
    "cif": "A12345678",
    "password": "miContraseña123"
    }
    ~~

## Validación en el backend
- El backend recibe la petición y busca al usuario en la base de datos(cli_usuario) usando usuario + cif
- Se compara la contraseña recibida con la que está en la base de datos (con hash)
    - Si coincide = login exitoso
    - Si no coincide = devolver un error 401 (Unauthorized)
- Tips de seguridad: siempre guarda contraseñas hasheadas y nunca en texto plano

## Generación de token JWT
- ¿Qué es?
    - Definición
        - JWT (JSON Web Token) es un estándar abierto (RFC 7519) que permite transmitir información de forma segura entre un cliente y un servidor
        - Se utiliza principalmente para autenticación (saber quién eres) y autorización (qué puedes hacer)
    - Estructura de un JWT
        - Un JWT es un token de texto que tiene tres partes separadas por puntos(.)
            ~~~css
            Header.Payload.Signature
            ~~~
        - Ejemplo
            ~~~js
            eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9
            .eyJ1c3VhcmlvIjoiZGF2aWQiLCJyb2wiOiJhZG1pbiIsImV4cCI6MTY5MDUyODAwMH0
            .H0YpNwRjTz7YcPLO0JYd8WkjJq7UzFhv9g2mM4ojfQk
            ~~~
    - Header (cabecera)
        - Indica el algoritmo de firma y el tipo de token
            ~~~json
            {
                "alg": "HS256",
                "typ": "JWT"
            }
            ~~~
    - Payload (carga útil)
        - Contiene los claims (información que queremos guardar)
            - Datos del usuario (id, nombre, rol)
            - Restricciones de seguridad (fecha de expiración)
            - Ejemplo
                ~~~json
                {
                    "usuario": "david",
                    "rol": "admin",
                    "exp": 1735689600
                }
                ~~~
    - Signature (firma)
        - Sirve para comprobar que el token no ha sido alterado
        - Se genera con
            ~~~css
            HMACSHA256( header + payload, clave_secreta )
            ~~~
        - Solo el servidor conoce la clave secreta, por eso nadie puede falsificar un token válido
    - ¿Para qué sirve JWT?
        - Autenticación
            - El usuario inicia sesión con su usuario y contraseña
            - El servidor genera un JWT y se lo envía al cliente
            - El cliente guarda el JST (en localStorage)
            - En cada petición, el cliente envía el JWT en el header:
                ~~~css
                Authorization: Bearer <JWT>
                ~~~
        - Autorización
            - El token puede incluir información sobre roles y permisos
            - Ejemplo: si el payload tiene "rol": "admin", el backend puede permitir más acciones
    - Ventajas 
        - Seguro -> el servidor valida la firma y la expiración
        - Stateless -> no es necesario guardar sesiones en memoria del servidor
        - Escalable -> funciona bien en sistemas distribuidos y microservicios
        - Flexible -> se pueden incluir roles, permisos o datos adicionales en el payload
    - Desventajas
        - Si el token es robado, el atacante puede usarlo hasta que caduque
        - Los tokens no se pueden "revocar" fácilmente, a menos que uses un sistema extra(lista negra, refresh token ...)
        - No debe incluir información sensible (como contraseñas), porque aunque está firmado, el payload está codificado en base64 y cualquiera puede leerlo
    - Resumen rápido
        - JWT = token seguro en formato JSON, firmado digitalmente, usado para autenticación y autorización
        - Tiene 3 partes: Header + Payload + Signature
        - Se envía en cada petición dentro del header Authorization
        - Expira automáticamente tras un tiempo definido

- Se crea un payload con la información mínima necesaria:
    ~~~json
    {
        "usuario": "david",
        "cif": "A12345678",
        "rol": "admin",
        "exp": 1735689600  // Fecha de expiración en formato Unix timestamp
    }
    ~~~
- Se firma el payload con una clave secreta del servidor (no visible al frontend)
- El resultado es un JWT, algo así:
    ~~~bash
    eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c3VhcmlvIjoiZGF2aWQiLCJjaWYiOiJBMTIzNDU2NzgiLCJyb2wiOiJhZG1pbiIsImV4cCI6MTczNTY4OTYwMH0.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c
    ~~~
- Se envía el JWT al frontend en la respuesta del login
    ~~~json
    {
        "token": "<JWT>"
    }
    ~~~

## Almacentamiento del token en el frontend
- Opciones comunes:
    - sessionStorage: el token se pierde al cerrar el navegador
    - localStorage: el token persiste aunque cierres la página
    - memoria (estado de React): más seguro, pero se pierde si refrescas la página
- Tips de seguridad: nunca guardes el token en cookies sin protección, a menos que sean HJttpOnly y Secure

## Uso del token en las peticiones posteriores
- Cuando el usuario navega a la página de Inicio y otras rutas:
    - El frontend envía el token en el header Authorization:
        ~~~js
        GET /api/inicio
        Authorization: Bearer <JWT>
        ~~~
    - El backend recibe la petición, extrae el token y lo valida:
        - Comprueba la firma: el token no ha sido modificado
        - Comprueba la expiración: el token no ha caducado
        - Extrae los datos del usuario del payload (usuario, CIF, roles, ...)
    - Si el token es válido, devuelve los datos solicitados para renderizar la página

## Caducidad y renovación del token
- El token puede caducar (ej. 30 minutos)
- Opciones al caducar:
    - Volver a pedir login
    - Usar un refresh token para renovar automáticamente sin pedir usuario/contraseña
- El refresh token se guarda solo en backend o en cookie segura, nunca en el localStorage

## Beneficios de usar JWT
- Seguridad: No envías contraseñas en cada petición
- Stateless: No necesitas guardar sesiones en memoria
- Escalable: Funciona en múltiples servidores o microservicios
- Información en el token: Puedes incluir roles, permisos y datos mínimos
- Caducidad automática: token expira automáticamente

## Resumen gráfico del flujo
- Login (usuario + cif + contraseña) -> POST (/api/auth/login)
- Backend valida y genera JWT -> devuelve token
- Frontend almacena el token
- Frontend hace peticiones -> añade Authorization: Bearer <JWT>
- Backend valida el token -> devuelve datos
- Token expira -> login o refresh token